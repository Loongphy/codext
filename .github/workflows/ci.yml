name: ci

on:
  push:
    tags:
      - "rust-v*"
  workflow_dispatch:
    inputs:
      release-version:
        description: Version to publish (x.y.z or x.y.z-alpha.N). Required for manual runs.
        required: false
        type: string
      publish:
        description: Whether to publish to npm after packaging.
        required: false
        default: true
        type: boolean

jobs:
  package:
    name: Package npm module
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.metadata.outputs.version }}
      npm_tag: ${{ steps.metadata.outputs.npm_tag }}
      pack_output: ${{ steps.stage_npm_package.outputs.pack_output }}
    env:
      NODE_OPTIONS: --max-old-space-size=4096
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Resolve release metadata
        id: metadata
        run: |
          set -euo pipefail
          version="${{ inputs.release-version }}"

          if [[ -z "${version}" ]]; then
            if [[ "${GITHUB_REF_NAME:-}" =~ ^rust-v.+ ]]; then
              version="${GITHUB_REF_NAME#rust-v}"
            else
              echo "release-version is required for workflow_dispatch when ref is not rust-v*."
              exit 1
            fi
          fi

          npm_tag=""
          if [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+-alpha\.[0-9]+$ ]]; then
            npm_tag="alpha"
          fi

          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "npm_tag=${npm_tag}" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # stage_npm_packages.py requires DotSlash when staging releases.
      - uses: facebook/install-dotslash@v2

      - name: Stage npm package
        id: stage_npm_package
        env:
          GH_TOKEN: ${{ github.token }}
          CODEX_VERSION: ${{ steps.metadata.outputs.version }}
        run: |
          set -euo pipefail
          OUTPUT_DIR="${RUNNER_TEMP}"
          python3 ./scripts/stage_npm_packages.py \
            --release-version "$CODEX_VERSION" \
            --package codex \
            --output-dir "$OUTPUT_DIR"
          PACK_OUTPUT="${OUTPUT_DIR}/codex-npm-${CODEX_VERSION}.tgz"
          echo "pack_output=$PACK_OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Upload staged npm package artifact
        uses: actions/upload-artifact@v6
        with:
          name: codex-npm-staging
          path: ${{ steps.stage_npm_package.outputs.pack_output }}

  publish:
    name: Publish npm package
    needs: package
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node.js for npm trusted publishing
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      # Trusted publishing requires npm CLI version 11.5.1 or later.
      - name: Update npm
        run: npm install -g npm@latest

      - name: Download npm tarball
        uses: actions/download-artifact@v6
        with:
          name: codex-npm-staging
          path: dist/npm

      - name: Publish to npm
        env:
          VERSION: ${{ needs.package.outputs.version }}
          NPM_TAG: ${{ needs.package.outputs.npm_tag }}
        run: |
          set -euo pipefail
          tag_args=(--provenance)
          if [[ -n "${NPM_TAG}" ]]; then
            tag_args+=(--tag "${NPM_TAG}")
          fi
          npm publish "dist/npm/codex-npm-${VERSION}.tgz" "${tag_args[@]}"
